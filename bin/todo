#!/bin/bash

# This is the "check mark" used to denote when an item is checked off the
# todo list. This can be changed by users in the source code below
CHK='_'

returner=0 # default

if [ ! -z "$1" ]; then
  LIST_FILE="`pwd`/$1"
else
  LIST_FILE="$HOME/todo"
fi

if [ ! -f "$LIST_FILE" ]; then
  echo "Error: File $LIST_FILE not found." >&2
  exit 1
fi

TMP_NAME=$LIST_FILE".tmp"

# process the list

# The sed way
sed "/^$CHK/d" < "$LIST_FILE" > "$TMP_NAME" || returner=1
sed -n "/^$CHK/p" < "$LIST_FILE" >> "$TMP_NAME" || returner=1

# The grep way -- this fails for cases where everything is checked off
#grep -v "^$CHK" < "$LIST_FILE" > "$TMP_NAME" || returner=1
#grep "^$CHK" < "$LIST_FILE" >> "$TMP_NAME" || returner=1

if [ $returner == 0 ]; then # everything is normal
  chmod --reference="$LIST_FILE" "$TMP_NAME"
  mv "$TMP_NAME" "$LIST_FILE"
else
  echo "Error processing list. See $LIST_FILE and $TMP_NAME" >&2
  exit 2
fi

# open the list
vim "$LIST_FILE"
returner=$?

exit $returner
